<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Announcements</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
    <!-- Only load TinyMCE when we're on the announcement creation view -->
    {% if course_id and tinymce_api_key %}
    <script src="https://cdn.tiny.cloud/1/{{ tinymce_api_key }}/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
    <script>
        tinymce.init({
            selector: '#body',
            plugins: 'advlist autolink link image lists charmap print preview code',
            toolbar: 'undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media | forecolor backcolor',
            height: 300
        });
    </script>
    {% endif %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
    /* This ensures only one view is displayed by hiding the other when not needed */
    #course-selection-view { display: {% if course_id %}none{% else %}block{% endif %}; }
    #announcement-creation-view { display: {% if course_id %}block{% else %}none{% endif %}; }
    </style>
</head>
<body>
    <div class="container mt-2">
        <!-- COURSE SELECTION VIEW -->
        <div id="course-selection-view" class="card shadow">
            <div class="card-header bg-primary text-white">
                <h1 class="h5 mb-0">Select a Course</h1>
            </div>
            <div class="card-body">
                <form action="/" method="GET">
                    <ul class="list-group mb-3">
                        {% for course in courses %}
                        <li class="list-group-item d-flex align-items-center">
                            <input type="radio" id="course_{{ course.id }}" name="course_id" value="{{ course.id }}" class="form-check-input me-2" required data-course-name="{{ course.name }}">
                            <label for="course_{{ course.id }}" class="form-check-label">{{ course.name }}</label>
                        </li>
                        {% endfor %}
                    </ul>
                    <input type="hidden" id="course_name_input" name="course_name" value="">
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
        </div>

        <!-- ANNOUNCEMENT CREATION VIEW -->
        <div id="announcement-creation-view" class="card shadow">
            <div class="card-header bg-primary text-white">
                <h1 class="h5 mb-0">Create Announcement for {{ course_name }}</h1>
            </div>
            <div class="card-body">
                <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data">
                    <input type="hidden" name="course_id" value="{{ course_id }}">
                    <input type="hidden" name="course_name" value="{{ course_name }}">

                    <div class="mb-3">
                        <label for="title" class="form-label">Title:</label>
                        <input type="text" class="form-control" id="title" name="title" value="{{ default_title }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="file" class="form-label">File to Upload:</label>
                        <input type="file" class="form-control" id="file" name="file" required>
                    </div>

                    <div class="mb-3">
                        <label for="body" class="form-label">Announcement Body:</label>
                        <textarea id="body" name="body" class="form-control">{{ default_body|safe }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="publish_at" class="form-label">Publish Date:</label>
                        <input type="datetime-local" class="form-control" id="publish_at" name="publish_at" value="{{ default_publish_datetime }}">
                        {% if now %}
                        <small class="text-muted">(Set to publish immediately)</small>
                        {% else %}
                        <small class="text-muted">(Set to publish at the specified time)</small>
                        {% endif %}
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Create Announcement</button>
                        <a href="/" class="btn btn-secondary">Back to Course Selection</a>
                    </div>
                </form>

                <div id="result" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Modal for response messages -->
    <div id="modal" class="modal">
        {% include 'modal_content.html' %}
    </div>

    <script>
        // Course selection handler
        var courseRadios = document.querySelectorAll('input[name="course_id"]');
        if (courseRadios.length > 0) {
            courseRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const selectedCourseName = this.getAttribute('data-course-name');
                    document.getElementById('course_name_input').value = selectedCourseName;
                });
            });
        }

        // Form submission handler for announcement creation
        var uploadForm = document.getElementById('upload-form');
        if (uploadForm) {
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();

                // Show loading message
                document.getElementById('result').innerHTML = '<div class="alert alert-info">Uploading file and creating announcement...</div>';

                // Get form data
                var formData = new FormData(this);

                // Send AJAX request
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('result').innerHTML = '<div class="alert alert-success">Announcement created successfully!</div>';
                        showModal('Success', data.message);
                    } else {
                        document.getElementById('result').innerHTML = '<div class="alert alert-danger">Error: ' + data.message + '</div>';
                        showModal('Error', data.message);
                    }
                })
                .catch(error => {
                    document.getElementById('result').innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
                    showModal('Error', 'An error occurred during the upload.');
                });
            });
        }
    </script>
</body>
</html>
